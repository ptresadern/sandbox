{% extends "base.html" %}

{% block title %}Gallery - Phil & Rachel's Wedding Album{% endblock %}

{% block content %}
<div class="gallery-container">
    <h1>Phil & Rachel's Wedding Album</h1>

    {% if files or total_files > 0 %}
        <div class="gallery-stats">
            <div>
                <p>Showing {{ files|length }} of {{ total_files }} items (Page {{ page }} of {{ total_pages }})</p>
            </div>
            <div class="gallery-controls">
                <div class="control-group">
                    <label for="per-page-selector">Items per page:</label>
                    <select id="per-page-selector" class="per-page-selector">
                        <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                        <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="column-selector">Columns:</label>
                    <select id="column-selector" class="column-selector">
                        <option value="2">2 Columns</option>
                        <option value="3">3 Columns</option>
                        <option value="4" selected>4 Columns</option>
                        <option value="5">5 Columns</option>
                        <option value="6">6 Columns</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="gallery-grid">
            {% for file in files %}
                <div class="gallery-item" data-type="{{ file.type }}">
                    {% if file.type == 'image' %}
                        <img src="{{ file.url }}" alt="{{ file.name }}" loading="lazy" onclick="openModal('{{ file.url }}', '{{ file.name }}', 'image')">
                    {% elif file.type == 'video' %}
                        <div class="video-thumbnail" onclick="openModal('{{ file.url }}', '{{ file.name }}', 'video')">
                            <div class="play-icon">â–¶</div>
                            <video src="{{ file.url }}" preload="metadata"></video>
                        </div>
                    {% endif %}
                    <div class="gallery-item-info">
                        <p class="file-name" title="{{ file.name }}">{{ file.name }}</p>
                        <p class="file-meta">{{ (file.size / 1024 / 1024) | round(2) }} MB</p>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Pagination Controls -->
        {% if total_pages > 1 %}
        <div class="pagination-container">
            <div class="pagination">
                <!-- First and Previous buttons -->
                {% if page > 1 %}
                <a href="{{ url_for('gallery', page=1, per_page=per_page) }}" class="pagination-btn">
                    <span>&laquo; First</span>
                </a>
                <a href="{{ url_for('gallery', page=page-1, per_page=per_page) }}" class="pagination-btn">
                    <span>&lsaquo; Previous</span>
                </a>
                {% else %}
                <span class="pagination-btn disabled">&laquo; First</span>
                <span class="pagination-btn disabled">&lsaquo; Previous</span>
                {% endif %}

                <!-- Page Numbers -->
                <div class="pagination-numbers">
                    {% set start_page = [1, page - 2]|max %}
                    {% set end_page = [total_pages, page + 2]|min %}

                    {% if start_page > 1 %}
                        <a href="{{ url_for('gallery', page=1, per_page=per_page) }}" class="pagination-number">1</a>
                        {% if start_page > 2 %}
                            <span class="pagination-ellipsis">...</span>
                        {% endif %}
                    {% endif %}

                    {% for p in range(start_page, end_page + 1) %}
                        {% if p == page %}
                            <span class="pagination-number active">{{ p }}</span>
                        {% else %}
                            <a href="{{ url_for('gallery', page=p, per_page=per_page) }}" class="pagination-number">{{ p }}</a>
                        {% endif %}
                    {% endfor %}

                    {% if end_page < total_pages %}
                        {% if end_page < total_pages - 1 %}
                            <span class="pagination-ellipsis">...</span>
                        {% endif %}
                        <a href="{{ url_for('gallery', page=total_pages, per_page=per_page) }}" class="pagination-number">{{ total_pages }}</a>
                    {% endif %}
                </div>

                <!-- Next and Last buttons -->
                {% if page < total_pages %}
                <a href="{{ url_for('gallery', page=page+1, per_page=per_page) }}" class="pagination-btn">
                    <span>Next &rsaquo;</span>
                </a>
                <a href="{{ url_for('gallery', page=total_pages, per_page=per_page) }}" class="pagination-btn">
                    <span>Last &raquo;</span>
                </a>
                {% else %}
                <span class="pagination-btn disabled">Next &rsaquo;</span>
                <span class="pagination-btn disabled">Last &raquo;</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
    {% else %}
        <div class="empty-state">
            <h2>No media files yet</h2>
            <p>Upload some photos or videos to get started!</p>
            <a href="{{ url_for('upload') }}" class="btn btn-primary">Upload Files</a>
        </div>
    {% endif %}
</div>

<!-- Modal for viewing media -->
<div id="mediaModal" class="modal">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <div class="modal-content">
        <img id="modalImage" src="" alt="" style="display:none;">
        <video id="modalVideo" controls style="display:none;">
            <source src="" type="video/mp4">
        </video>
        <div class="modal-caption" id="modalCaption"></div>
    </div>
</div>

<script>
    // Column selector functionality
    const columnSelector = document.getElementById('column-selector');
    const galleryGrid = document.querySelector('.gallery-grid');

    if (columnSelector && galleryGrid) {
        // Load saved preference or use default
        const savedColumns = localStorage.getItem('galleryColumns') || '4';
        columnSelector.value = savedColumns;
        updateGalleryColumns(savedColumns);

        // Listen for column changes
        columnSelector.addEventListener('change', function() {
            const columns = this.value;
            updateGalleryColumns(columns);
            localStorage.setItem('galleryColumns', columns);
        });

        function updateGalleryColumns(columns) {
            galleryGrid.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
        }
    }

    // Per-page selector functionality
    const perPageSelector = document.getElementById('per-page-selector');

    if (perPageSelector) {
        perPageSelector.addEventListener('change', function() {
            const perPage = this.value;
            // Redirect to page 1 with new per_page value
            const url = new URL(window.location.href);
            url.searchParams.set('page', '1');
            url.searchParams.set('per_page', perPage);
            window.location.href = url.toString();
        });
    }

    // Modal functions
    function openModal(url, name, type) {
        const modal = document.getElementById('mediaModal');
        const modalImage = document.getElementById('modalImage');
        const modalVideo = document.getElementById('modalVideo');
        const modalCaption = document.getElementById('modalCaption');

        modalImage.style.display = 'none';
        modalVideo.style.display = 'none';

        if (type === 'image') {
            modalImage.src = url;
            modalImage.style.display = 'block';
        } else if (type === 'video') {
            modalVideo.querySelector('source').src = url;
            modalVideo.load();
            modalVideo.style.display = 'block';
        }

        modalCaption.textContent = name;
        modal.style.display = 'flex';
    }

    function closeModal() {
        const modal = document.getElementById('mediaModal');
        const modalVideo = document.getElementById('modalVideo');
        modalVideo.pause();
        modal.style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('mediaModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });
</script>
{% endblock %}
